---
- name: Docker Registry With CA Deploy
  hosts: servers
  become: yes
  
  tasks:
    - name: Gather information about Docker containers
      command: docker ps -aq
      register: docker_container_ids
      changed_when: false
      ignore_errors: yes

    - name: Stop and remove Docker containers
      docker_container:
        name: "{{ item }}"
        state: absent
      loop: "{{ docker_container_ids.stdout_lines }}"

    - name: Stop UFW service
      ansible.builtin.service:
        name: ufw
        state: stopped

    - name: Uninstall UFW
      ansible.builtin.apt:
        name: ufw
        state: absent

    - name: Create /home/registry/certs directory
      file:
        path: /home/registry/certs
        state: directory
        mode: '0755'

    - name: Create /home/registry/auth directory
      file:
        path: /home/registry/auth
        state: directory
        mode: '0755'

    - name: Update Package Cache
      apt:
        update_cache: yes

    - name: Install required packages
      apt:
        name: "{{ item }}"
        state: present
      loop:
        - apt-transport-https
        - ca-certificates
        - curl
        - openssl
        - apache2-utils

    - name: Generate htpasswd hash for (user:username & pass:password)
      shell: sudo htpasswd -Bbn username password
      register: htpasswd_result

    - name: Display htpasswd hash for (user:username & pass:password)
      debug:
        var: htpasswd_result.stdout

    - name: Save htpasswd result to file for (user:username & pass:password)
      copy:
        content: "{{ htpasswd_result.stdout }}"
        dest: /home/registry/auth/htpasswd
        mode: '0644'
